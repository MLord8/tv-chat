<html>
<body>
    <input type="text", id="message"></input>
    <button id="sendMessage">Send</button>
    <button id="enterChannel">Enter Channel</button>
    <div id="chatBox" style="position: absolute; top: 150px; background: gray; width: 400; height: 400"></div>
</body>
<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.12.4.min.js"></script>
<script src="C:\Users\wadoo_000\Desktop\College\SideProjects\tv-chat\src\node_modules\sendbird\SendBird.min.js"></script>
<script>

var sb;
var appId = 'D74C7631-8912-4A8E-868D-1B1959ACE31A'
var tv_channel;
sb = new SendBird({
    appId: appId
});

//sb.connect(USER_ID, function(user, error) {});
sb.connect('nrickles3', '8ad51bfd0feff2c6c41b6fe84e1a50085468cd23', function(user, error, callback) {
    execute();
});

function execute() {
/*
sb.updateCurrentUserInfo(NICKNAME, PROFILE_URL, function(response, error) {
  console.log(response, error);
}); //is this necessary?
*/

/*
//dynamically creating channels
sb.OpenChannel.createChannel(NAME, COVER_URL, DATA, function (channel, error) {
    if (error) {
        console.error(error);
        return;
    }
    console.log(channel);
});
*/
$("#createChannel").click(function() {
    sb.OpenChannel.createChannel($("#message").val(), '', '', function (channel, error) {
        if (error) {
            console.error(error);
            return;
        }
        console.log(channel);
    });
});


//get list of channels

var openChannelListQuery = sb.OpenChannel.createOpenChannelListQuery();
var channels = [];
var messages = [];
var currChannel = null;
var currChannelURL = "";
var currTime = 0;
openChannelListQuery.next(function (response, error) {
    if (error) {
        console.log(error);
        return;
    }

    console.log(response);
    $.each(response, function(key, value) {
        channels.push({name: value.name, url: value.url});
    });
    console.log(channels);
});


$("#enterChannel").click(function() {
    for (var i = 0; i < channels.length; i++) {
        if ($("#message").val() == channels[i].name) {
            //enter an open channel
            sb.OpenChannel.getChannel(channels[i].url, function (channel, error, callback) {
                if (error) {
                    console.error(error);
                    return;
                }
                console.log(channel);

                channel.enter(function(response, error){
                    if (error) {
                        console.error(error);
                        return;
                    }

                    currChannel = channel;
                    currTime = 0;
                    updateChat();
                });
            });
            currChannelURL = channels[i].url;
        }
    }
});

/*
//exiting a channel
sb.OpenChannel.getChannel(CHANNEL_URL, function (channel, error) {
    if (error) {
        console.error(error);
        return;
    }

    channel.exit(function(response, error){
        if (error) {
            console.error(error);
            return;
        }
    });
});

//loading previous messages
var messageListQuery = channel.createPreviousMessageListQuery();

messageListQuery.load(20, true, function(messageList, error){
    if (error) {
        console.error(error);
        return;
    }
    console.log(messageList);
});
*/
//sending messages
$("#sendMessage").click(function() {
    currChannel.sendUserMessage($("#message").val(), '', function(message, error, callback){
        if (error) {
            console.error(error);
            return;
        }
        console.log(message);
        updateChat();
    });
})

function updateChat() {
    //setInterval(function() {
    $("#chatBox").empty();
    messages = [];
        var messageListQuery = currChannel.createPreviousMessageListQuery();

        messageListQuery.load(20, true, function(messageList, error){
            if (error) {
                console.error(error);
                return;
            }
        console.log(messageList);

            $.each(messageList, function(key, value) {
                messages.push({nickname: value.sender.nickname, message: value.message, createdAt: value.createdAt});
            });
            messages.reverse();

            for (i = 0; i < messages.length; i++) {
                console.log(messages[i].createdAt >= currTime);
                if (messages[i].createdAt >= currTime) {
                    $("#chatBox").append("<p><b>" + messages[i].nickname + "</b>: " + messages[i].message + "</p>");
                }
            }

            currTime = messages[0].createdAt;
        });
    //}, 1000)
}

var ConnectionHandler = new sb.ConnectionHandler();

ConnectionHandler.onReconnectStarted = function(){
    alert("reconnect");
};

ConnectionHandler.onReconnectSucceeded = function(){
    alert("reconnect succeeded");
};

ConnectionHandler.onReconnectFailed = function(){
    alert("reconnect failed");
};
sb.addConnectionHandler('uniqueID', ConnectionHandler);

//receiving messages
/*var ChannelHandler = new sb.ChannelHandler();

ChannelHandler.onMessageReceived = function(channel, message){
    console.log('ChannelHandler.onMessageReceived: ', channel, message);
};

sb.addChannelHandler('UNIQUE_HANDLER_ID', ChannelHandler);
function receiveMessage() {
    $("#chatBox").append("<p>test</p>");
}
*/

}
</script>
